import { Component, OnInit, inject } from '@angular/core';
import { HttpErrorResponse } from '@angular/common/http';
import { FormsModule } from '@angular/forms';
import { NavigationButtonComponent } from 'src/app/shared/navigation-button/navigation-button.component';
import {
  CategoryResponse,
  CategoryService,
  IdentifierResponse,
  TransactionRequest,
  TransactionResponse,
  TransactionService,
} from 'generated-sources/openapi';

@Component({
  selector: 'app-categorize',
  templateUrl: './categorize.component.html',
  styleUrls: ['./categorize.component.scss'],
  imports: [FormsModule, NavigationButtonComponent],
})
export class CategorizeComponent implements OnInit {
  private transactionService = inject(TransactionService);
  private categorySerivce = inject(CategoryService);
  transactions?: TransactionResponse[];
  categories?: CategoryResponse[];
  update: TransactionRequest[] = [];

  constructor() {}

  ngOnInit(): void {
    console.log('ngOnInit');
    this.transactionService.getUncategorizedTransactions().subscribe({
      next: (v) => {
        this.transactions = v;
      },
      error: (error: HttpErrorResponse) => {
        console.log(`error: ${error.message}`);
      },
    });
    this.categorySerivce.getCategories().subscribe({
      next: (v) => {
        this.categories = v;
      },
      error: (error: HttpErrorResponse) => {
        console.log(`error ${error.message}`);
      },
    });
  }

  onSave() {
    this.update.length = 0;
    console.log('onSave');
    for (let transaction of this.transactions!) {
      console.log(transaction);
    }
    if (this.transactions) {
      for (let transaction of this.transactions!) {
        if (transaction.identifier) {
          var identifierRequest: IdentifierResponse = transaction.identifier;
          var transactionRequest: TransactionRequest = {
            amount: transaction.amount!,
            date: transaction.date!,
            id: transaction.id!,
            purpose: transaction.purpose!,
            source: transaction.source!,
            userID: transaction.userID!,
            identifier: identifierRequest,
          };
          this.update.push(transactionRequest);
        }
      }
      if (this.update.length > 0) {
        throw new Error('get out length is ' + this.update.length);
        console.log('sending');
        console.log(this.update);
        this.transactionService.categorizeTransactions(this.update).subscribe({
          next: (v) => {
            console.log(v);
            this.ngOnInit();
          },
          error: (error: HttpErrorResponse) => {
            console.log(`Error message: ${error.message}`);
          },
          complete: () => (this.update.length = 0),
        });
      }
    }
  }

  recategorize() {
    console.log('recategorize');
    this.transactionService.recategorizeTransactions().subscribe({
      next: (v) => {
        console.log(v);
        this.ngOnInit();
      },
    });
  }

  getUndefined(category: CategoryResponse): string {
    // return JSON.stringify(
    //   category.identifier?.find(
    //     (ele) => ele.label === category.label + '_default',
    //   ),
    // );
    var identifier = category.identifier!.find(
      (ele) => ele.label === category.label + '_default',
    );
    // console.log(identifier);
    if (identifier === undefined) {
      throw new Error(
        'Cant find undefined identifier for category' + category.label,
      );
    }
    return JSON.stringify(identifier);
  }
}
